{template 'common/header'}
{template 'web/tree'}
<style>
    .form-control{
        display:inline;
        width:50%;
    }
    .task_box{
        width:20px;
        height:20px;
    }
    .data_select{
        width:100%;
    }
</style>
<div class="clearfix">
    <div class="panel panel-default">
        <div class="panel-heading">

            <a class="btn btn-default" href="javascript:;" data-toggle="modal" data-target="#modal-strategy-ad" onclick="setEdit('','')">
                <i class="fa fa-plus"></i>
                新增策略
            </a>

        </div>
        <div class="panel-body">
                        <table class="table table-hover" style="overflow: visible;">
                            <thead class="navbar-inner">
                                <tr>

                                    <th width="5%">id</th>
                                    <th>名称</th>
                                    <th>制定者</th>
                                    <th>总时间</th>
                                    <th>扣点</th>
                                    <th>随机</th>
                                    <th>空闲任务</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {loop $strategy $row}
                                <tr>
                                    <td>{$row['id']}</td>
                                    <td>{$row['name']}</td>
                                    <td>{php echo $this->_getusername($row['owner'])}</td>
                                    <td>{$row['full_time']} 秒</td>
                                    <td>{$row['cost']} 点</td>
                                    <td>{if $row['is_ramd']==1}是{else}否{/if}</td>
                                    <td>{php echo $this->_gettaskname($row['idle']);}</td>
                                    <td>
                                        <a href="javascript:;" onclick="show_task('{$row['name']}','{$row['info']}',{$row['id']})" data-toggle="modal" data-target="#modal-see-ad" class="btn btn-default btn-sm">查看</a>
                                        <a href="javascript:;" onclick="edit_task('{$row['info']}',{$row['id']})" data-toggle="modal" data-target="#modal-edit-ad" class="btn btn-default btn-sm">编辑</a>
                                        <a href="{php echo $this->createWebUrl('strategy',array('dopost'=>'del','id'=>$row['id']))}" onclick="return confirm('确认删除?')" class="btn btn-default btn-sm" data-toggle="tooltip" data-placement="top" title="删除">
                                            <i class="fa fa-remove"></i>
                                        </a>
                                    </td>
                                </tr>
                                {/loop}
                            </tbody>
                        </table>
        </div>
    </div>
</div>


<!-- 查看策略 -->
<div id="modal-see-ad" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true" style="width: 100%; margin: 0px auto;">
        <div class="modal-dialog" style="width: 800px;">
            <div class="modal-content">
                <div class="modal-header">
                    <button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
                    <h3 class="strategy_name"></h3>
                    <h5 class="strategy_info"></h5>
                </div>
                <div class="modal-body">
                        <table class="table table-hover" style="overflow: visible;">
                            <thead class="navbar-inner">
                                <tr>
                                  <th>优先级</th>
                                  <th>脚本id</th>
                                  <th>数据id</th>
                                  <th>运行次数</th>
                                  <th>任务运行时间</th>
                                </tr>
                            </thead>
                            <tbody id="allot">
                                
                            </tbody>
                        </table>


                </div>
                <div class="modal-footer">
                    <a href="#" class="btn" data-dismiss="modal" aria-hidden="true">关  闭</a>
                </div>
            </div>
        </div>
</div>


<script>
    function show_task(name,info,id){
        

       // $.ajax({//获取
       //       url:"{php echo $this->createWebUrl('strategy')}",
       //       type:'post',
       //       data:{
       //          id:id,
       //         dopost:'get_strategy_name',
       //       },success:function(msg){
       //          $(".strategy_name").html(msg);
       //       }
       // })

            


        $(".strategy_name").html(name);
        $(".strategy_info").html(info);
        $("#allot").html("");
        var data="id="+id;  
            $.getJSON("{php echo $this->createWebUrl('strategy',array('dopost'=>'show_task'))}",data, function(json){
                    $.each(json,function(i,result){

                            item = "<tr><td>"+result['task_pri']+"</td><td>"+result['task_id']+"</td><td>"+result['task_d_id']+"</td><td>"+result['task_num']+"</td><td>"+result['task_time']+" s</td></tr>"; 
                        $('#allot').append(item); 
                    });

            }); 

    }
</script>








<!-- 添加幻灯片 -->
<div id="modal-strategy-ad" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true" style="width: 100%; margin: 0px auto;">
    <form class="form-horizontal form" onsubmit="return check()" action="{php echo $this->createWebUrl('strategy',array('dopost'=>'add'))}" method="post" enctype="multipart/form-data">
        <div class="modal-dialog" style="width: 1200px;">
            <div class="modal-content">
                <div class="modal-header">
                    <button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
                    <h3>新增策略</h3>
                </div>
                <div class="modal-body">
                    <a class="btn btn-default" href="javascript:;" data-toggle="modal" data-target="#modal-task-ad">
                        <i class="fa fa-plus"></i>
                        添加任务
                    </a>
                    <div class="form-group">
                        <table class="table table-hover" style="overflow: visible;">
                            <thead class="navbar-inner">
                                <tr>
                                    <th width="100px" style="text-align: center;">脚本编号</th>
                                    <th width="20%">任务原始名称</th>
                                    <th width="20%">说明</th>
                                    <th width="20%"></th>
                                    <th width="20%"style="text-align: center;">添加数据</th>

                                </tr>
                            </thead>
                            <tbody id="task_list">
<!--                                 {loop $task_list $row}
                                <tr>
                                    <td style="align:center;">
                                        <input type="checkbox" class="form-control task_box" name="ms_task_index[]" value="{$row['id']}">
                                        <span class="time_box"></span>
                                    </td>
                                    <td align="center">{$row['id']}</td>
                                    <td title="{$row['origin_name']}">{$row['origin_name']}</td>
                                    <td title="{$row['info']}">{$row['info']}</td>
                                    <td align="center">            
                                        <select name="task_d_id[]"  class="form-control data_select">
                                            <option value="0"></option>
                                            {loop $data_list $d_row}
                                            <option value="{$d_row['id']}">{$d_row['origin_name']}</option>
                                            {/loop}
                                        </select>
                                    </td>
                                </tr>
                                {/loop} -->
                            </tbody>
                        </table>
                        <div class="form-group">
                            <label class="col-xs-10 col-sm-3 col-md-3 control-label">空闲任务</label>
                            <div class="col-sm-3 col-xs-12">
                                <a class="btn btn-default" href="javascript:;" data-toggle="modal" data-target="#modal-idle-ad" style="display:inline-block;float:left;">
                                    <i class="fa fa-plus"></i>
                                    选择
                                </a>
                                <span id="idle" style="margin-left: 10px;line-height: 35px;">
                                    
                                </span>
                                <input type="hidden" name="idle" value=""/>
                                
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-xs-10 col-sm-3 col-md-3 control-label">执行一轮时间</label>
                            <div class="col-sm-3 col-xs-12">
                                <input name="full_time" class="form-control" required id="full_time"/> 秒
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-xs-10 col-sm-3 col-md-3 control-label">扣点数</label>
                            <div class="col-sm-6 col-xs-12">
                                <input name="cost" class="form-control" required id="cost"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-xs-10 col-sm-3 col-md-3 control-label">是否随机</label>
                            <div class="col-sm-6 col-xs-12">
                                <input type="radio" name="is_ramd" class="form-control" required style="height:15px;width:20px" checked value="1"/> 是
                                <input type="radio" name="is_ramd" class="form-control" required style="height:15px;width:20px"  value="0"/> 否
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-xs-10 col-sm-3 col-md-3 control-label">名称</label>
                            <div class="col-sm-6 col-xs-12">
                                <input name="name" class="form-control" required id="name" style="width:50%"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-xs-10 col-sm-3 col-md-3 control-label">说明</label>
                            <div class="col-sm-6 col-xs-12">
                                <input name="info" class="form-control" required id="info" style="width:100%"/>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary span2" name="add-ad" value="yes">确  认</button>
                    <a href="#" class="btn" data-dismiss="modal" aria-hidden="true">关  闭</a>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- 添加幻灯片 -->
<div id="modal-task-ad" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true" style="width: 100%; margin: 0px auto;">
        <div class="modal-dialog" style="width: 800px;">
            <div class="modal-content">
                <div class="modal-header">
                    <button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
                    <h3>脚本列表</h3>
                </div>
                <div class="modal-body">
                        <table class="table table-hover" style="overflow: visible;">
                            <thead class="navbar-inner">
                                <tr>
                                    <th width="100px" style="text-align: center;">脚本编号</th>
                                    <th width="30%">任务原始名称</th>
                                    <th width="30%">说明</th>
                                    <th width="100px"></th>

                                </tr>
                            </thead>
                            <tbody>
                                {loop $task_list $row}
                                
                                <tr>
                                    <td align="center">
                                        <label for="{$row['id']}">{$row['id']}</label>
                                    </td>
                                    <td title="{$row['origin_name']}">
                                        <label for="{$row['id']}">{$row['origin_name']}</label>
                                    </td>
                                    <td title="{$row['info']}">
                                        <label for="{$row['id']}">{$row['info']}</label>
                                    </td>
                                    <td>
                                        <input type="radio" name="task-radio" id="{$row['id']}"  value="{$row['id']}" style="width:20px;height:20px">
                                    </td>
                                </tr>
                                
                                {/loop}
                            </tbody>
                        </table>


                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary span2" onclick="choose()"  data-dismiss="modal" aria-hidden="true">确  认</button>
                    <a href="#" class="btn" data-dismiss="modal" aria-hidden="true">关  闭</a>
                </div>
            </div>
        </div>
</div>


<!-- 添加幻灯片 -->
<div id="modal-idle-ad" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true" style="width: 100%; margin: 0px auto;">
        <div class="modal-dialog" style="width: 800px;">
            <div class="modal-content">
                <div class="modal-header">
                    <button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
                    <h3>空闲任务列表</h3>
                </div>
                <div class="modal-body">
                        <table class="table table-hover" style="overflow: visible;">
                            <thead class="navbar-inner">
                                <tr>
                                    <th width="100px" style="text-align: center;">脚本编号</th>
                                    <th width="30%">任务原始名称</th>
                                    <th width="30%">说明</th>
                                    <th width="100px"></th>

                                </tr>
                            </thead>
                            <tbody>
                                {loop $idle_list $row}
                                
                                <tr>
                                    <td align="center">
                                        <label for="{$row['id']}">{$row['id']}</label>
                                    </td>
                                    <td title="{$row['origin_name']}">
                                        <label for="{$row['id']}">{$row['origin_name']}</label>
                                    </td>
                                    <td title="{$row['info']}">
                                        <label for="{$row['id']}">{$row['info']}</label>
                                    </td>
                                    <td>
                                        <input type="radio" name="idle-radio" id="{$row['id']}"  value="{$row['id']}" style="width:20px;height:20px">
                                    </td>
                                </tr>
                                
                                {/loop}
                            </tbody>
                        </table>


                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary span2" onclick="choose_idle()"  data-dismiss="modal" aria-hidden="true">确  认</button>
                    <a href="#" class="btn" data-dismiss="modal" aria-hidden="true">关  闭</a>
                </div>
            </div>
        </div>
</div>




<script>

function choose(){
    var id = $('input:radio[name="task-radio"]:checked').val();
    
    $.ajax({
        url:"{php echo $this->createWebUrl('strategy',array('dopost'=>'select'))}",
        dataType:'json',
        data:{
          id:id
        },
        success:function(data){

            // var count={$count};
            var count=10;
            var sort='<option value="0">优先级</option>';
            for (var i=1;i<=count;i++){
              sort=sort + '<option value="'+i+'">'+i+'</option>';
            }


            var str='<input name="task_time[]" type="text" class="form-control task_time" required style="width:70px;"/> 秒 <input name="task_num[]" type="text" class="form-control task_num" required style="width:40px;"/> 次 '+'<select name="task_pri[]" class="form-control task_pri" style="width:80px;padding-right:0px;">'+sort+'</select>';

            $("#task_list").append("<tr><td align='center'><input type='hidden' name='ms_task_index[]' value='"+data.id+"'>"+data.id+"</td><td title='"+data.origin_name+"'>"+data.origin_name+"</td><td title='"+data.info+"'>"+data.info+"</td><td style='align:center;'>"+str+"</td><td align='center'><select name='task_d_id[]'  class='form-control data_select'><option value='0'></option>{loop $data_list $d_row}<option value='{$d_row['id']}'>{$d_row['origin_name']}</option>{/loop}</select></td></tr>");
        }
    })


}

function choose_idle(){
    var id = $('input:radio[name="idle-radio"]:checked').val();
    $.ajax({
        url:"{php echo $this->createWebUrl('strategy',array('dopost'=>'select'))}",
        dataType:'json',
        data:{
          id:id
        },
        success:function(data){
            $("#idle").html(data.origin_name+" - "+data.info);
            $('input[name=idle]').val(id);
        }
    })



    
}


function  setEdit(id,name)
{
    $("#edit_name").val(name);
    $("#edit_id").val(id);
}

function  check(){
   var task_time= $(".task_time");
  for(var i=0;i<task_time.length;i++){
    if(isNaN(task_time[i].value)){
        alert("第"+(i+1)+"个脚本时间需填 数字");
        return false;
    }
  }

   var task_pri= $(".task_pri");
  for(var i=0;i<task_pri.length;i++){
    if(task_pri[i].value==0){
        alert("第"+(i+1)+"个排序不能为空");
        return false; 
    }
  }

    if($('input[name=idle]').val()==""){
        alert("请选择一个空闲任务");
        return false; 
    }



 if(isNaN($("#full_time").val())){
        alert("执行一轮时间需填 数字");
        return false; 
 }

 if(isNaN($("#cost").val())){
        alert("扣点数时间需填 数字");
        return false; 
 }


}


</script>

{template 'common/footer'}
